(function () {
    // Define the test variations
    var variations = [
        { url: "https://www.ampdlocal.com/", weight: 50, name: "Ampd Local" },
        { url: "https://www.admaxlocal.com/", weight: 50, name: "AdMax Local" }
    ];

    // Function to pick a variation based on weights
    function pickVariation() {
        var rand = Math.random() * 100;
        var cumulative = 0;
        for (var i = 0; i < variations.length; i++) {
            cumulative += variations[i].weight;
            if (rand < cumulative) {
                return variations[i];  // Return full object, not just URL
            }
        }
        return variations[0]; // Default fallback
    }

    // Check if user has already been assigned a variation
    var storedVariant = localStorage.getItem("ab_test_variant");
    var variantObj;

    if (storedVariant) {
        try {
            // Parse only if it's a valid JSON object
            variantObj = JSON.parse(storedVariant);
        } catch (e) {
            console.error("Invalid JSON in localStorage, resetting test variant.");
            variantObj = pickVariation();
            localStorage.setItem("ab_test_variant", JSON.stringify(variantObj));
        }
    } else {
        // Pick new variation and store it correctly
        variantObj = pickVariation();
        localStorage.setItem("ab_test_variant", JSON.stringify(variantObj));
    }

    // Ensure proper tracking of variant
    gtag('event', 'A_B_Test_Assignment', {
        'event_category': 'A/B Test',
        'event_label': variantObj.name
    });
    console.log('User assigned to Variation:', variantObj.name);

    // Redirect the user
    if (window.location.href !== variantObj.url) {
        window.location.href = variantObj.url;
    }
})();
